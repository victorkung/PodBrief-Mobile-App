# PodBrief Backend & Frontend Changes ‚Äî February 8, 2026

> **Purpose:** This document summarizes all changes made on February 8, 2026. Use this to update the Replit mobile app accordingly.

---

## TL;DR ‚Äî What Changed

1. **Groq Whisper replaced by Deepgram Nova-2** ‚Äî Fallback transcription now uses Deepgram. `transcript_source` values are `'taddy'` or `'deepgram'` (no more `'groq'`).
2. **Structural quality validation** ‚Äî Summary quality gate upgraded from word-count-only to structural section checks. Retry uses `gemini-2.5-pro` as fallback model.
3. **Failure push notifications** ‚Äî New `sendBriefFailedNotification()` sends push when brief generation fails. Deep link payload includes `masterBriefId`.
4. **`retry-taddy-transcript` ‚Äî Full background orchestration** ‚Äî Now runs the entire summarization pipeline (extraction + synthesis + audio) after a successful transcript fetch.
5. **`regenerate-summary` ‚Äî Missing transcript recovery** ‚Äî Resets brief to `'failed'` if transcript data is missing, allowing re-trigger without additional credit charge.
6. **Audio player speed options updated** ‚Äî New 11-option range (0.75x‚Äì1.25x in 0.05 increments). Frontend only.
7. **New episodes fetch limit increased** ‚Äî `limitPerPage` changed from 30 to 50 in `useNewEpisodes.ts`.

---

## 1. Groq Whisper Replaced by Deepgram Nova-2

The fallback transcription service changed from **Groq Whisper** (`whisper-large-v3-turbo`) to **Deepgram Nova-2**.

### Key Differences

| Aspect | Previous (Groq) | New (Deepgram) |
|--------|-----------------|----------------|
| Secret | `GROQ_API_KEY` | `DEEPGRAM_API_KEY` |
| `transcript_source` value | `'groq'` | `'deepgram'` |
| File size limit | 100 MB | 2 GB |
| Cost | ~$0.11/hour | ~$0.26/hour |
| Speed | ~30x real-time | ~120x real-time |

### Technical Details

- Shared transcription logic lives in `_shared/transcription.ts` with three exported helpers:
  - `transcribeWithDeepgram(audioUrl, logger)` ‚Äî Calls Deepgram Nova-2 API
  - `formatDeepgramTranscript(paragraphs)` ‚Äî Converts Deepgram paragraph output to 60-second chunked timestamps (same format as Taddy)
  - `resolveRedirects(url, logger)` ‚Äî Resolves tracking redirects (Chartable, Podtrac, etc.) to get direct audio URL
- Deepgram uses `paragraphs=true` parameter for structured sentence/paragraph output
- Partial transcript acceptance: if Deepgram returns at least 50% of expected characters (based on duration estimate), the transcript is accepted rather than hard-failing

### Mobile Impact

**If the mobile app displays `transcript_source` anywhere or filters by it:**
- Replace `'groq'` references with `'deepgram'`
- The `brief_transcripts.transcript_source` column now only contains `'taddy'` or `'deepgram'`

**If the mobile app does NOT reference `transcript_source`:**
- No changes needed ‚Äî Deepgram fallback is transparent to the client

---

## 2. Structural Quality Validation (New Quality Gate)

The summary quality gate has been upgraded from word-count-only to **structural validation**.

### New Function: `validateSummaryStructure()`

Located in `_shared/gemini.ts`, this function checks for required sections:

```typescript
export function validateSummaryStructure(
  summary: string,
  hasOutro: boolean
): StructureValidation {
  // Checks for:
  // 1. ## Executive Summary heading
  // 2. ## Key Takeaways heading
  // 3. At least 3 ### Part N chronological sections
  // 4. Outro text (if configured via ai_config)
  return { isComplete: boolean, missingParts: string[] };
}
```

### Quality Retry Logic

1. **Primary model:** `gemini-3-flash-preview` (defined as `GEMINI_MODEL`)
2. **Quality check triggers retry if:**
   - `finishReason !== 'STOP'` (abnormal termination)
   - OR `validateSummaryStructure()` reports incomplete structure
3. **15-second cooldown** between initial attempt and retry
4. **Retry model:** `gemini-2.5-pro` (defined as `GEMINI_FALLBACK_MODEL`)
5. Word count check is kept for monitoring/logging but is **no longer the primary gate**

### Where It's Applied

- `generate-brief` ‚Äî During synthesis phase
- `regenerate-summary` ‚Äî During re-synthesis

### Mobile Impact

- **No changes needed** ‚Äî Quality validation is fully server-side
- `pipeline_status` values remain unchanged (`summarizing` ‚Üí `completed` or `summary_failed`)

---

## 3. Failure Push Notifications (New)

Push notifications are now sent when brief generation **fails**, not just when it succeeds.

### New Helper

```typescript
// _shared/pushNotifications.ts
export async function sendBriefFailedNotification(
  expoPushToken: string,
  episodeName: string,
  masterBriefId: string,
  logger?: (msg: string, data?: Record<string, unknown>) => void
): Promise<boolean>
```

### Notification Content

| Field | Value |
|-------|-------|
| Title | `"Summary generation failed"` |
| Body | `"We couldn't generate a summary for {episodeName}"` |
| Data | `{ masterBriefId: "..." }` |

### Where It's Sent From

| Edge Function | Failure Scenario |
|---------------|-----------------|
| `generate-brief` | Pipeline failures (transcription or summarization) |
| `regenerate-summary` | Quality validation failures after retry |
| `retry-taddy-transcript` | Summarization failures during background orchestration |

- Fire-and-forget (errors are logged but don't affect pipeline status)

### Mobile Impact

**Required:** Handle the failure notification deep link:
- Payload structure is the same (`{ masterBriefId }`)
- On tap, navigate to the brief detail screen
- The brief will have `pipeline_status: 'failed'` or `'summary_failed'`
- Show the appropriate recovery action ("Try Again" or "Regenerate Summary")

---

## 4. `retry-taddy-transcript` ‚Äî Full Background Orchestration

This function now runs the **entire summarization pipeline** in the background after a successful transcript fetch, rather than just saving the transcript and exiting.

### New Behavior

After transcript is saved:
1. Calls `runSummarizationPipeline()` via `EdgeRuntime.waitUntil` (non-blocking)
2. Pipeline includes:
   - Phase 1: **Extraction** (Gemini condensed transcript)
   - Phase 2: **Synthesis** (Gemini full summary with structural validation)
   - Quality retry if needed (15s cooldown + fallback model)
   - Triggers `generate-audio` on success
3. `generate-audio` remains the sole authority for setting `pipeline_status: 'completed'`
4. On failure: sets `pipeline_status: 'failed'` and sends failure push notification

### Deepgram Fallback in Retry

If Taddy fails during retry, Deepgram is attempted automatically:
- Redirect resolution for tracking URLs
- Same partial acceptance threshold (50% of expected characters)
- `transcript_source` set to `'deepgram'`

### Mobile Impact

- **No changes needed** ‚Äî The function still accepts the same request payload and returns the same initial response
- Pipeline status polling works identically
- The only difference is that the background work now includes the full pipeline instead of just the transcript step

---

## 5. `regenerate-summary` ‚Äî Missing Transcript Recovery

If `regenerate-summary` is called on a brief that has **no condensed transcript** (e.g., a brief that failed mid-pipeline):

### New Behavior

```json
// HTTP 200 response when transcript is missing
{
  "success": true,
  "resetToFailed": true,
  "message": "Brief reset to failed status ‚Äî transcript data was missing. User can re-trigger the full pipeline."
}
```

### What Happens Server-Side

1. Brief `pipeline_status` ‚Üí `'failed'`
2. Transcript data cleared (raw + condensed)
3. Audio metadata cleared (`audio_url`, `audio_duration_seconds`)
4. Summary text cleared

### Mobile Impact

**Handle the `resetToFailed: true` flag:**
- When this flag is present in the response, update the local brief state to `pipeline_status: 'failed'`
- Switch the UI from "Regenerate Summary" to "Try Again" (which calls `retry-taddy-transcript`)
- No additional credit is charged ‚Äî the user can re-trigger the full pipeline

---

## 6. Audio Player Speed Options Updated (Frontend Only)

The `SPEED_OPTIONS` array in `src/lib/audioUtils.ts` was updated:

| Previous (9 options) | New (11 options) |
|----------------------|------------------|
| 0.5x, 0.75x, 0.9x, 1x, 1.1x, 1.25x, 1.5x, 1.75x, 2x | 0.75x, 0.8x, 0.85x, 0.9x, 0.95x, 1x, 1.05x, 1.1x, 1.15x, 1.2x, 1.25x |

### Key Changes

- Range narrowed from **0.5x‚Äì2x** to **0.75x‚Äì1.25x**
- Step size changed from variable to consistent **0.05 increments**
- Speed is persisted via `localStorage` (key: `podbrief-playback-speed`) ‚Äî no backend change

### Mobile Impact

**Recommended:** Update the mobile speed selector to match the new range (0.75x‚Äì1.25x in 0.05 increments). This ensures consistency between web and mobile when users switch platforms.

---

## 7. New Episodes Fetch Limit Increased (30 ‚Üí 50)

`useNewEpisodes.ts` now sends `limitPerPage: 50` (was 30) to the `taddy-latest-episodes` edge function.

### Technical Details

- The edge function already supported up to 50 via `Math.min(limitPerPage, 50)` clamping
- No backend change was needed
- Episodes are still displayed 10 at a time with "Load More" pagination

### Mobile Impact

**Recommended:** If the mobile app calls `taddy-latest-episodes` with its own `limitPerPage`, consider updating to 50 to match. This gives users more episodes to browse before hitting the limit.

---

## Quick Reference: Pipeline Status Values

| Status | Meaning | User Recovery |
|--------|---------|---------------|
| `pending` | Brief created, waiting to start | Automatic |
| `transcribing` | Fetching transcript from Taddy/Deepgram | Wait |
| `summarizing` | AI extraction + synthesis in progress | Wait |
| `recording` | Audio generation in progress | Wait |
| `completed` | Brief fully ready (summary + audio) | ‚Äî |
| `failed` | Transcript or pipeline error | "Try Again" ‚Üí calls `retry-taddy-transcript` |
| `summary_failed` | AI quality check failed | "Regenerate Summary" ‚Üí calls `regenerate-summary` |

---

## Recommended Mobile Actions

### ‚ö†Ô∏è Required

1. **Update `transcript_source` handling** ‚Äî If the app references `'groq'`, change to `'deepgram'`
2. **Handle failure push notifications** ‚Äî New deep link scenario where brief has `pipeline_status: 'failed'` or `'summary_failed'`. Show appropriate recovery action on tap.
3. **Handle `resetToFailed` response** ‚Äî When `regenerate-summary` returns `{ resetToFailed: true }`, switch UI to "Try Again" flow

### üìã Recommended

4. **Update speed selector** ‚Äî Match new 0.75x‚Äì1.25x range with 0.05 increments
5. **Increase episode fetch limit** ‚Äî Send `limitPerPage: 50` when calling `taddy-latest-episodes`

### ‚úÖ No Changes Needed

- Pipeline status polling works the same
- `retry-taddy-transcript` request/response contract is unchanged
- `regenerate-summary` request contract is unchanged (only new response flag added)
- Quality validation is fully server-side
- Deepgram fallback is transparent to the client
- Deduplication guard from Feb 7 still active

---

*Generated from PodBrief web + backend changes on February 8, 2026.*
