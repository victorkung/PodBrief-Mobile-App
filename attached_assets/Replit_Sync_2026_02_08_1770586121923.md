# PodBrief Backend & Frontend Changes ‚Äî February 8, 2026

> **Purpose:** This document summarizes all changes made on February 8, 2026. Use this to update the Replit mobile app accordingly.

---

## TL;DR ‚Äî What Changed

1. **Groq Whisper replaced by Deepgram Nova-2** ‚Äî Fallback transcription now uses Deepgram. `transcript_source` values are `'taddy'` or `'deepgram'` (no more `'groq'`).
2. **Structural quality validation** ‚Äî Summary quality gate upgraded from word-count-only to structural section checks. Retry uses `gemini-2.5-pro` as fallback model.
3. **Failure push notifications** ‚Äî New `sendBriefFailedNotification()` sends push when brief generation fails. Deep link payload includes `masterBriefId`.
4. **`retry-taddy-transcript` ‚Äî Full background orchestration** ‚Äî Now runs the entire summarization pipeline (extraction + synthesis + audio) after a successful transcript fetch.
5. **`regenerate-summary` ‚Äî Missing transcript recovery** ‚Äî Resets brief to `'failed'` if transcript data is missing, allowing re-trigger without additional credit charge.
6. **Audio player speed options updated** ‚Äî New 11-option range (0.75x‚Äì1.25x in 0.05 increments). Frontend only.
7. **New episodes fetch limit increased** ‚Äî `limitPerPage` changed from 30 to 50 in `useNewEpisodes.ts`.
8. **Language-aware "Summarized" badge** ‚Äî Brief existence checks now filter by the user's `preferred_language`. The EpisodeDetail page was fixed to match this pattern.
9. **CJK-aware word counting** ‚Äî Whitespace-based word counting replaced with CJK-aware utility across frontend and `get-public-brief-preview` edge function. Fixes amber error banners and reading time for CJK briefs.
10. **Exact MP3 duration from frame parsing** ‚Äî `generate-audio` now reads exact audio duration from MP3 frame headers instead of estimating via word count. Language-agnostic, always accurate.

---

## 1. Groq Whisper Replaced by Deepgram Nova-2

The fallback transcription service changed from **Groq Whisper** (`whisper-large-v3-turbo`) to **Deepgram Nova-2**.

### Key Differences

| Aspect | Previous (Groq) | New (Deepgram) |
|--------|-----------------|----------------|
| Secret | `GROQ_API_KEY` | `DEEPGRAM_API_KEY` |
| `transcript_source` value | `'groq'` | `'deepgram'` |
| File size limit | 100 MB | 2 GB |
| Cost | ~$0.11/hour | ~$0.26/hour |
| Speed | ~30x real-time | ~120x real-time |

### Technical Details

- Shared transcription logic lives in `_shared/transcription.ts` with three exported helpers:
  - `transcribeWithDeepgram(audioUrl, logger)` ‚Äî Calls Deepgram Nova-2 API
  - `formatDeepgramTranscript(paragraphs)` ‚Äî Converts Deepgram paragraph output to 60-second chunked timestamps (same format as Taddy)
  - `resolveRedirects(url, logger)` ‚Äî Resolves tracking redirects (Chartable, Podtrac, etc.) to get direct audio URL
- Deepgram uses `paragraphs=true` parameter for structured sentence/paragraph output
- Partial transcript acceptance: if Deepgram returns at least 50% of expected characters (based on duration estimate), the transcript is accepted rather than hard-failing

### Mobile Impact

**If the mobile app displays `transcript_source` anywhere or filters by it:**
- Replace `'groq'` references with `'deepgram'`
- The `brief_transcripts.transcript_source` column now only contains `'taddy'` or `'deepgram'`

**If the mobile app does NOT reference `transcript_source`:**
- No changes needed ‚Äî Deepgram fallback is transparent to the client

---

## 2. Structural Quality Validation (New Quality Gate)

The summary quality gate has been upgraded from word-count-only to **structural validation**.

### New Function: `validateSummaryStructure()`

Located in `_shared/gemini.ts`, this function checks for required sections:

```typescript
export function validateSummaryStructure(
  summary: string,
  hasOutro: boolean
): StructureValidation {
  // Checks for:
  // 1. ## Executive Summary heading
  // 2. ## Key Takeaways heading
  // 3. At least 3 ### Part N chronological sections
  // 4. Outro text (if configured via ai_config)
  return { isComplete: boolean, missingParts: string[] };
}
```

### Quality Retry Logic

1. **Primary model:** `gemini-3-flash-preview` (defined as `GEMINI_MODEL`)
2. **Quality check triggers retry if:**
   - `finishReason !== 'STOP'` (abnormal termination)
   - OR `validateSummaryStructure()` reports incomplete structure
3. **15-second cooldown** between initial attempt and retry
4. **Retry model:** `gemini-2.5-pro` (defined as `GEMINI_FALLBACK_MODEL`)
5. Word count check is kept for monitoring/logging but is **no longer the primary gate**

### Where It's Applied

- `generate-brief` ‚Äî During synthesis phase
- `regenerate-summary` ‚Äî During re-synthesis

### Mobile Impact

- **No changes needed** ‚Äî Quality validation is fully server-side
- `pipeline_status` values remain unchanged (`summarizing` ‚Üí `completed` or `summary_failed`)

---

## 3. Failure Push Notifications (New)

Push notifications are now sent when brief generation **fails**, not just when it succeeds.

### New Helper

```typescript
// _shared/pushNotifications.ts
export async function sendBriefFailedNotification(
  expoPushToken: string,
  episodeName: string,
  masterBriefId: string,
  logger?: (msg: string, data?: Record<string, unknown>) => void
): Promise<boolean>
```

### Notification Content

| Field | Value |
|-------|-------|
| Title | `"Summary generation failed"` |
| Body | `"We couldn't generate a summary for {episodeName}"` |
| Data | `{ masterBriefId: "..." }` |

### Where It's Sent From

| Edge Function | Failure Scenario |
|---------------|-----------------|
| `generate-brief` | Pipeline failures (transcription or summarization) |
| `regenerate-summary` | Quality validation failures after retry |
| `retry-taddy-transcript` | Summarization failures during background orchestration |

- Fire-and-forget (errors are logged but don't affect pipeline status)

### Mobile Impact

**Required:** Handle the failure notification deep link:
- Payload structure is the same (`{ masterBriefId }`)
- On tap, navigate to the brief detail screen
- The brief will have `pipeline_status: 'failed'` or `'summary_failed'`
- Show the appropriate recovery action ("Try Again" or "Regenerate Summary")

---

## 4. `retry-taddy-transcript` ‚Äî Full Background Orchestration

This function now runs the **entire summarization pipeline** in the background after a successful transcript fetch, rather than just saving the transcript and exiting.

### New Behavior

After transcript is saved:
1. Calls `runSummarizationPipeline()` via `EdgeRuntime.waitUntil` (non-blocking)
2. Pipeline includes:
   - Phase 1: **Extraction** (Gemini condensed transcript)
   - Phase 2: **Synthesis** (Gemini full summary with structural validation)
   - Quality retry if needed (15s cooldown + fallback model)
   - Triggers `generate-audio` on success
3. `generate-audio` remains the sole authority for setting `pipeline_status: 'completed'`
4. On failure: sets `pipeline_status: 'failed'` and sends failure push notification

### Deepgram Fallback in Retry

If Taddy fails during retry, Deepgram is attempted automatically:
- Redirect resolution for tracking URLs
- Same partial acceptance threshold (50% of expected characters)
- `transcript_source` set to `'deepgram'`

### Mobile Impact

- **No changes needed** ‚Äî The function still accepts the same request payload and returns the same initial response
- Pipeline status polling works identically
- The only difference is that the background work now includes the full pipeline instead of just the transcript step

---

## 5. `regenerate-summary` ‚Äî Missing Transcript Recovery

If `regenerate-summary` is called on a brief that has **no condensed transcript** (e.g., a brief that failed mid-pipeline):

### New Behavior

```json
// HTTP 200 response when transcript is missing
{
  "success": true,
  "resetToFailed": true,
  "message": "Brief reset to failed status ‚Äî transcript data was missing. User can re-trigger the full pipeline."
}
```

### What Happens Server-Side

1. Brief `pipeline_status` ‚Üí `'failed'`
2. Transcript data cleared (raw + condensed)
3. Audio metadata cleared (`audio_url`, `audio_duration_seconds`)
4. Summary text cleared

### Mobile Impact

**Handle the `resetToFailed: true` flag:**
- When this flag is present in the response, update the local brief state to `pipeline_status: 'failed'`
- Switch the UI from "Regenerate Summary" to "Try Again" (which calls `retry-taddy-transcript`)
- No additional credit is charged ‚Äî the user can re-trigger the full pipeline

---

## 6. Audio Player Speed Options Updated (Frontend Only)

The `SPEED_OPTIONS` array in `src/lib/audioUtils.ts` was updated:

| Previous (9 options) | New (11 options) |
|----------------------|------------------|
| 0.5x, 0.75x, 0.9x, 1x, 1.1x, 1.25x, 1.5x, 1.75x, 2x | 0.75x, 0.8x, 0.85x, 0.9x, 0.95x, 1x, 1.05x, 1.1x, 1.15x, 1.2x, 1.25x |

### Key Changes

- Range narrowed from **0.5x‚Äì2x** to **0.75x‚Äì1.25x**
- Step size changed from variable to consistent **0.05 increments**
- Speed is persisted via `localStorage` (key: `podbrief-playback-speed`) ‚Äî no backend change

### Mobile Impact

**Recommended:** Update the mobile speed selector to match the new range (0.75x‚Äì1.25x in 0.05 increments). This ensures consistency between web and mobile when users switch platforms.

---

## 7. New Episodes Fetch Limit Increased (30 ‚Üí 50)

`useNewEpisodes.ts` now sends `limitPerPage: 50` (was 30) to the `taddy-latest-episodes` edge function.

### Technical Details

- The edge function already supported up to 50 via `Math.min(limitPerPage, 50)` clamping
- No backend change was needed
- Episodes are still displayed 10 at a time with "Load More" pagination

### Mobile Impact

**Recommended:** If the mobile app calls `taddy-latest-episodes` with its own `limitPerPage`, consider updating to 50 to match. This gives users more episodes to browse before hitting the limit.

---

## 8. Language-Aware "Summarized" Badge (Bug Fix)

The web app now correctly filters the "Summarized" badge by the user's `preferred_language` across all screens.

### Problem

The Episode Detail page (`EpisodeDetail.tsx`) checked if the user had **any** brief for an episode, regardless of language. After switching from English to Spanish, the "Summarized" badge would still show even though no Spanish summary existed.

The New Episodes feed and Show Discovery pages already filtered by language correctly.

### Fix Applied (Web)

The `checkUserBrief` query in `EpisodeDetail.tsx` now joins `master_briefs` with a language filter:

```typescript
const { data } = await supabase
  .from('user_briefs')
  .select('id, master_briefs!inner(taddy_episode_uuid, language)')
  .eq('user_id', user.id)
  .eq('is_hidden', false)
  .eq('master_briefs.taddy_episode_uuid', episode.taddyEpisodeUuid)
  .eq('master_briefs.language', profile?.preferred_language || 'en')
  .maybeSingle();
```

The `useEffect` dependency array now includes `profile?.preferred_language`, so changing the language in Settings immediately re-evaluates the badge.

### How the Web App Handles Language-Aware Brief Checking

All three screens that show the "Summarized" status follow the same pattern:

1. **Query pattern**: Join `user_briefs` with `master_briefs!inner`, filter by:
   - `user_id = auth.uid()`
   - `is_hidden = false`
   - `master_briefs.language = profile.preferred_language`

2. **Re-evaluate on language change**: The `useEffect` dependency includes `profile?.preferred_language`, so changing language in Settings triggers re-fetch.

3. **Summary generation**: The `generate-brief` edge function reads `preferred_language` from the user's profile server-side ‚Äî no language parameter needs to be passed from the client.

### Mobile Impact

**Required:** The mobile app should implement the same language-aware filtering:
- When checking if a user has a brief for an episode, filter by `master_briefs.language` matching the user's `preferred_language`
- When the user changes their language in Settings, re-evaluate which episodes show as "Summarized"
- The backend reads the language from the profile during generation, so the mobile app just needs to ensure `profiles.preferred_language` is updated before triggering generation

---

## Quick Reference: Pipeline Status Values

| Status | Meaning | User Recovery |
|--------|---------|---------------|
| `pending` | Brief created, waiting to start | Automatic |
| `transcribing` | Fetching transcript from Taddy/Deepgram | Wait |
| `summarizing` | AI extraction + synthesis in progress | Wait |
| `recording` | Audio generation in progress | Wait |
| `completed` | Brief fully ready (summary + audio) | ‚Äî |
| `failed` | Transcript or pipeline error | "Try Again" ‚Üí calls `retry-taddy-transcript` |
| `summary_failed` | AI quality check failed | "Regenerate Summary" ‚Üí calls `regenerate-summary` |

---

## Recommended Mobile Actions

### ‚ö†Ô∏è Required

1. **Update `transcript_source` handling** ‚Äî If the app references `'groq'`, change to `'deepgram'`
2. **Handle failure push notifications** ‚Äî New deep link scenario where brief has `pipeline_status: 'failed'` or `'summary_failed'`. Show appropriate recovery action on tap.
3. **Handle `resetToFailed` response** ‚Äî When `regenerate-summary` returns `{ resetToFailed: true }`, switch UI to "Try Again" flow
4. **Language-aware brief checking** ‚Äî Filter "Summarized" badge by `master_briefs.language` matching `profile.preferred_language`

### üìã Recommended

5. **Update speed selector** ‚Äî Match new 0.75x‚Äì1.25x range with 0.05 increments
6. **Increase episode fetch limit** ‚Äî Send `limitPerPage: 50` when calling `taddy-latest-episodes`

### ‚úÖ No Changes Needed

- Pipeline status polling works the same
- `retry-taddy-transcript` request/response contract is unchanged
- `regenerate-summary` request contract is unchanged (only new response flag added)
- Quality validation is fully server-side
- Deepgram fallback is transparent to the client
- Deduplication guard from Feb 7 still active

---

## 9. Language Suffix Slugs for Non-English Briefs (New)

Non-English briefs now use a **language suffix** in their slug instead of a random string.

### Pattern

| Language | Slug Pattern | Example |
|----------|-------------|---------|
| English | `{base-slug}-{random}` | `episode-name-a3yndm` |
| Spanish | `{base-slug}-es` | `episode-name-es` |
| Mandarin Chinese | `{base-slug}-zh` | `episode-name-zh` |
| French | `{base-slug}-fr` | `episode-name-fr` |

### Technical Details

- `generateSlug(title, language)` in `generate-brief/index.ts` now accepts an optional `language` parameter
- English briefs (`language === 'en'` or no language) keep the existing random suffix pattern
- Non-English briefs get `{base-slug}-{language_code}` (e.g., `-es`, `-zh`, `-fr`)
- Uniqueness is guaranteed by the `(taddy_episode_uuid, language)` constraint on `master_briefs`

### Mobile Impact

**Required:** When generating slugs for non-English briefs on mobile (if applicable), use the same `{base-slug}-{lang}` pattern to maintain consistency.

---

## 10. "Chinese" Renamed to "Mandarin Chinese"

The language label for `zh` has been updated from "Chinese" to "Mandarin Chinese" in both:
- Frontend constants (`src/lib/constants.ts`)
- Backend AI prompt language helper (`_shared/gemini.ts` ‚Üí `getLanguageName()`)

This means AI prompts now say "Generate ALL output in Mandarin Chinese" for improved specificity.

### Mobile Impact

**Required:** Update the language selector label from "Chinese" to "Mandarin Chinese" for the `zh` language code.

---

## 11. CJK-Aware Validation Fix (Critical Bug Fix)

The summary quality validation has been updated to work correctly with CJK (Chinese, Japanese, Korean) languages.

### Problem

- `countWords()` split on whitespace only ‚Äî CJK text has no spaces, so a 2000+ character Chinese summary was counted as ~182 "words"
- `validateSummaryStructure()` checked for English-only headings (`Executive Summary`, `Key Takeaways`, `Part N`) ‚Äî Chinese summaries use translated headings like `ÊâßË°åÊëòË¶Å`, `Ê†∏ÂøÉË¶ÅÁÇπ`, `Á¨¨‰∏ÄÈÉ®ÂàÜ`

### Fix

1. **`countWords()`** now counts CJK characters individually (each character ‚âà one word equivalent). For mixed-language text, it uses whichever count is higher (CJK chars vs whitespace-split words).

2. **`validateSummaryStructure()`** now uses a **universal markdown structure check** instead of English-specific regex:
   - Checks for at least 2 `## ` (h2) headings
   - Checks for at least 3 `### ` (h3) headings
   - Outro check (`this concludes your`) only applies to English (`language === 'en'`)
   - This works for all languages since the Gemini prompt always instructs markdown formatting

3. The function now accepts a `language` parameter: `validateSummaryStructure(summary, hasOutro, language)`

### Where It's Applied

- `generate-brief/index.ts` ‚Äî Synthesis quality gate
- `regenerate-summary/index.ts` ‚Äî Re-synthesis quality gate
- `retry-taddy-transcript/index.ts` ‚Äî Now includes full structural validation (was word-count only)

### Mobile Impact

- **No changes needed** ‚Äî Validation is fully server-side
- CJK brief generation should now succeed where it previously failed

---

## 12. CJK-Aware Word Counting (Frontend + Public Preview)

Whitespace-based word counting has been replaced with a **CJK-aware utility** across the frontend and the `get-public-brief-preview` edge function.

### Problem

- `text.split(/\s+/).length` returns ~14 "words" for a 1,247-character Chinese summary
- This caused the amber error banner to appear on CJK briefs (word count fell below the 500-word threshold)
- Reading time displayed as "1 min read" instead of the correct value (~4 min)

### Fix: `countWords()` Utility

New shared utility in `src/lib/utils.ts`:

```typescript
export function countWords(text: string): number {
  if (!text || !text.trim()) return 0;
  const whitespaceWords = text.trim().split(/\s+/).filter(w => w.length > 0).length;
  const cjkPattern = /[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/g;
  const cjkChars = (text.match(cjkPattern) || []).length;
  return cjkChars > whitespaceWords ? cjkChars : whitespaceWords;
}
```

**Logic:** Detects CJK characters (Chinese, Japanese, Korean) and returns the **higher** count between whitespace-separated words and individual CJK characters. Each CJK character is treated as one "word equivalent."

### Where It's Applied

| Location | What Changed |
|----------|-------------|
| `src/components/brief/ContentTabs.tsx` | Summary, condensed, and transcript word counts now use `countWords()` |
| `src/pages/AdminAIConfig.tsx` | Admin quality threshold display uses `countWords()` |
| `supabase/functions/get-public-brief-preview/index.ts` | Public preview word count + reading time calculation uses inline CJK-aware logic |

### Mobile Impact

**If the mobile app calculates word counts or reading times client-side:**
- Replace `text.split(/\s+/).length` with CJK-aware logic (count individual CJK characters)
- CJK Unicode ranges to match: `\u4e00-\u9fff` (CJK Unified), `\u3400-\u4dbf` (CJK Extension A), `\uf900-\ufaff` (Compatibility), `\u3040-\u309f` (Hiragana), `\u30a0-\u30ff` (Katakana), `\uac00-\ud7af` (Korean Hangul)

**If the mobile app only displays server-provided word counts or reading times:**
- No changes needed ‚Äî the server now returns correct values

---

## 13. Exact MP3 Duration from Frame Parsing

The `generate-audio` edge function now reads **exact audio duration** from the MP3 frame headers instead of estimating via word count.

### Problem

The previous approach estimated duration using:

```typescript
const wordCount = cleanedText.split(/\s+/).filter(w => w.length > 0).length;
const estimatedDurationSeconds = Math.round((wordCount / 150) * 60);
```

This was **broken for CJK**: a Chinese summary with no spaces produced 14 "words" ‚Üí 58-second estimate for a file that was actually **5 minutes 39 seconds** (339s). The mobile player would show the wrong database value (0:58), then jump to the correct 5:39 when actual audio metadata loaded.

### Fix: `getMp3Duration()` Helper

New function in `supabase/functions/generate-audio/index.ts`:

```typescript
function getMp3Duration(data: Uint8Array): number {
  // Scans for MPEG frame sync headers (0xFF + 0xE0 mask)
  // Reads bitrate index, sample rate index from each frame header
  // Calculates: totalDuration += samplesPerFrame / sampleRate
  // Returns Math.round(totalDuration) in seconds
}
```

**How it works:**
1. Scans the `combinedAudio` byte array for MPEG frame sync words (11 set bits: `0xFF` followed by byte with `0xE0` mask)
2. Extracts MPEG version (1/2/2.5), layer (I/II/III), bitrate, and sample rate from each 4-byte frame header
3. Calculates `samples_per_frame / sample_rate` for each frame and sums to get total duration
4. Returns the rounded total in seconds

OpenAI TTS produces CBR (constant bitrate) MP3 files, so every frame has the same parameters ‚Äî the parser is reliable and fast.

### What Changed

| Aspect | Before | After |
|--------|--------|-------|
| Duration source | Word count √∑ 150 WPM | Actual MP3 frame headers |
| CJK accuracy | 58s estimate for 339s audio | 339s exact |
| English accuracy | ~¬±10% off | Exact |
| Stored value | `master_briefs.audio_duration_seconds` (estimated) | `master_briefs.audio_duration_seconds` (exact) |

### Data Correction

The existing Mandarin brief was corrected via SQL:

```sql
UPDATE master_briefs
SET audio_duration_seconds = 339
WHERE id = 'af87ab97-e381-440a-8ec1-3d937cf9659a';
```

### Mobile Impact

**No changes needed:**
- `audio_duration_seconds` from the database is now reliable for all languages
- The mobile player should no longer see a mismatch between stored duration and actual audio length
- No client-side duration correction or fallback is necessary

---

## Recommended Mobile Actions

### ‚ö†Ô∏è Required

1. **Update `transcript_source` handling** ‚Äî If the app references `'groq'`, change to `'deepgram'`
2. **Handle failure push notifications** ‚Äî New deep link scenario where brief has `pipeline_status: 'failed'` or `'summary_failed'`. Show appropriate recovery action on tap.
3. **Handle `resetToFailed` response** ‚Äî When `regenerate-summary` returns `{ resetToFailed: true }`, switch UI to "Try Again" flow
4. **Language-aware brief checking** ‚Äî Filter "Summarized" badge by `master_briefs.language` matching `profile.preferred_language`

### üìã Recommended

5. **Update speed selector** ‚Äî Match new 0.75x‚Äì1.25x range with 0.05 increments
6. **Increase episode fetch limit** ‚Äî Send `limitPerPage: 50` when calling `taddy-latest-episodes`
7. **CJK-aware word counting** ‚Äî If calculating word counts or reading times client-side, replace whitespace splitting with CJK character counting (see Section 12)

### ‚úÖ No Changes Needed

- Pipeline status polling works the same
- `retry-taddy-transcript` request/response contract is unchanged
- `regenerate-summary` request contract is unchanged (only new response flag added)
- Quality validation is fully server-side
- Deepgram fallback is transparent to the client
- Deduplication guard from Feb 7 still active
- **Audio duration is now exact from the server** ‚Äî no client-side correction needed
- **CJK brief generation and display** work correctly end-to-end

---

*Generated from PodBrief web + backend changes on February 8, 2026.*
