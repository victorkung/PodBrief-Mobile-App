# PodBrief Backend Changes — February 7, 2026

> **Purpose:** This document summarizes backend changes made on February 7, 2026. Use this to update the Replit mobile app accordingly.

---

## TL;DR — What Changed

1. **`generate-taddy-brief` renamed to `generate-brief` (BREAKING)** — The old endpoint returns 404. Update all invocations.
2. **`retry-taddy-transcript` — Deduplication guard added** — Returns `{ status: "already_processing" }` if a pipeline is already running. Prevents double Deepgram calls, double emails, and double push notifications.
3. **`retry-taddy-transcript` — Premature completion + notifications removed** — No longer sets `pipeline_status: 'completed'` or sends notifications. Both are now owned by `generate-audio`.
4. **`regenerate-summary` — Same fix applied** — Completion and notification ownership moved to `generate-audio`.
5. **`generate-audio` — Now sends email + push notifications** — After audio upload completes and `pipeline_status` is set to `completed`, notifications are dispatched to all users who own the brief.

---

## 1. BREAKING: `generate-taddy-brief` → `generate-brief`

The edge function was renamed. The request/response contract is identical.

```typescript
// ❌ BROKEN — returns 404
await supabase.functions.invoke('generate-taddy-brief', { body: { ... } });

// ✅ CORRECT
await supabase.functions.invoke('generate-brief', { body: { ... } });
```

---

## 2. `retry-taddy-transcript` — Deduplication Guard

**Problem:** If the mobile app calls `retry-taddy-transcript` twice in quick succession (e.g., user double-taps the retry button), two full pipelines ran in parallel causing:
- 2× Deepgram transcription calls (double cost)
- 2× emails sent
- 2× push notifications
- Race conditions on `pipeline_status`

**Fix:** A deduplication guard now checks `pipeline_status` before processing. If the brief is already in an active state (`transcribing`, `summarizing`, or `recording`), the function returns immediately:

```json
// HTTP 200 response when duplicate call detected
{
  "status": "already_processing",
  "message": "Brief is currently summarizing",
  "currentStatus": "summarizing"
}
```

**Mobile action:** Debounce the retry button to prevent rapid duplicate calls. The guard handles server-side protection, but debouncing avoids unnecessary network requests.

---

## 3. Pipeline Completion Ownership — `generate-audio` is the Authority

### Architecture Change

Previously, both `retry-taddy-transcript` and `regenerate-summary` set `pipeline_status: 'completed'` and sent notifications immediately after triggering `generate-audio`. This was a race condition — notifications arrived before audio was actually ready.

**New architecture:** `generate-audio` is the **sole authority** for:
1. Setting `pipeline_status: 'completed'` (after audio upload succeeds)
2. Setting `pipeline_status: 'failed'` (if audio generation fails)
3. Sending email notifications via `send-brief-ready-email`
4. Sending push notifications via Expo push tokens

### Flow Summary

| Flow | Audio Generation | Who Sets `completed`? | Who Sends Notifications? |
|------|-----------------|----------------------|--------------------------|
| `generate-brief` (standard) | Inline | `generate-brief` itself | `generate-brief` itself |
| `regenerate-summary` (retry) | Calls `generate-audio` | `generate-audio` | `generate-audio` |
| `retry-taddy-transcript` (retry) | Calls `generate-audio` | `generate-audio` | `generate-audio` |

**Key insight:** `generate-brief` never calls `generate-audio` — it handles audio inline. So there's zero risk of double notifications on the standard flow.

---

## 4. Notification Behavior

After `generate-audio` successfully uploads the audio file and sets `pipeline_status: 'completed'`:

1. **Email:** Calls `send-brief-ready-email` for each user who owns the brief (via `user_briefs` table)
2. **Push:** Sends an Expo push notification to each user with a configured `expo_push_token`
3. Both are fire-and-forget (errors are logged but don't affect pipeline status)

**Mobile impact:** Users will now receive exactly **one** email and **one** push notification per completed brief, regardless of which flow generated it. No duplicate notifications.

---

## 5. Error Handling (Unchanged)

If `generate-audio` fails:
- `pipeline_status` → `'failed'`
- `audio_status` → `'failed'`
- `audio_error` → error message
- Error logged to `error_logs` table

If the HTTP call to `generate-audio` itself fails (from `retry-taddy-transcript`):
- `pipeline_status` → `'failed'`
- `pipeline_error` → descriptive error message

---

## Quick Reference: Pipeline Status Values

| Status | Meaning | User Recovery |
|--------|---------|---------------|
| `pending` | Brief created, waiting to start | Automatic |
| `transcribing` | Fetching transcript from Taddy/Deepgram | Wait |
| `summarizing` | AI extraction + synthesis in progress | Wait |
| `recording` | Audio generation in progress | Wait |
| `completed` | Brief fully ready (summary + audio) | — |
| `failed` | Transcript or pipeline error | "Try Again" → calls `retry-taddy-transcript` |
| `summary_failed` | AI quality check failed | "Regenerate Summary" → calls `regenerate-summary` |

---

## Recommended Mobile Actions

### ⚠️ Required

1. **Rename `generate-taddy-brief` → `generate-brief`** — Old endpoint returns 404
2. **Debounce retry button** — Prevent rapid duplicate calls to `retry-taddy-transcript`
3. **Handle `already_processing` response** — When `retry-taddy-transcript` returns `{ status: "already_processing" }`, show a message like "Brief is already being processed" rather than an error

### ✅ Already Working (No Changes Needed)

- Pipeline status polling works the same way
- Push notification deep linking works the same way (payload still includes `masterBriefId`)
- Email notifications work the same way
- Error states and recovery flows work the same way

---

*Generated from PodBrief web app changes on February 7, 2026.*
