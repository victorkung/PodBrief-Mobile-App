# PodBrief Backend Changes — February 6, 2026

> **Purpose:** This document summarizes all database schema, edge function, and architectural changes made to the PodBrief web app on February 6, 2026. Use this to update the Replit mobile app accordingly.

---

## TL;DR — What Changed

1. **Database schema: Split tables completed (BREAKING)** — Pipeline orchestration and transcript data moved out of `master_briefs` into dedicated `brief_pipeline_state` and `brief_transcripts` tables. Several columns were **dropped** from `master_briefs`.
2. **Database schema: `user_briefs.total_duration_minutes` dropped (BREAKING)** — Use `master_briefs.total_duration_minutes` via JOIN instead.
3. **Database schema: `master_briefs.source` default changed** — Default is now `'taddy'` (was `'youtube'`). All existing rows updated.
4. **Edge function: Transcript retry logic simplified** — `generate-taddy-brief` now makes at most 2 Taddy transcript calls (1 initial + 1 retry after 60 seconds), down from 12 retries over ~5 minutes. Failed transcripts are marked `failed` immediately for manual user retry.
5. **Edge function: Dead Taddy status checks removed** — The `getEpisode` query for `taddyTranscribeStatus` was removed from `generate-taddy-brief`. Transcript availability is now determined solely by inspecting the item count from `getEpisodeTranscript`.
6. **Codebase cleanup: ~2,000 lines of dead code removed** — Legacy components, unused hooks, and dead edge functions deleted. No backend behavior changes from this cleanup.

---

## 1. BREAKING: Columns Dropped from `master_briefs`

The following columns **no longer exist** on `master_briefs`. Any queries selecting these will fail.

### Moved to `brief_pipeline_state` (1:1 via `master_brief_id`):

| Dropped Column | New Location |
|---|---|
| `pipeline_error` | `brief_pipeline_state.pipeline_error` |
| `summary_phase` | `brief_pipeline_state.summary_phase` |
| `audio_status` | `brief_pipeline_state.audio_status` |
| `audio_error` | `brief_pipeline_state.audio_error` |
| `processing_lock_holder` | `brief_pipeline_state.processing_lock_holder` |
| `processing_started_at` | `brief_pipeline_state.processing_started_at` |
| `transcript_completed_at` | `brief_pipeline_state.transcript_completed_at` |
| `summary_completed_at` | `brief_pipeline_state.summary_completed_at` |
| `pipeline_completed_at` | `brief_pipeline_state.pipeline_completed_at` |

### Moved to `brief_transcripts` (1:1 via `master_brief_id`):

| Dropped Column | New Location |
|---|---|
| `transcript_content` | `brief_transcripts.transcript_content` |
| `ai_condensed_transcript` | `brief_transcripts.ai_condensed_transcript` |

### Still on `master_briefs` (intentionally kept):

- `pipeline_status` — Kept denormalized for fast filtering and realtime subscriptions
- `summary_text` — Kept for brief display
- `audio_url` — Kept for audio playback
- `audio_duration_seconds` — Kept for player UI
- All episode metadata columns (episode_name, podcast_name, etc.)

### Required Query Migration

```typescript
// ❌ BROKEN — these columns no longer exist on master_briefs
const { data } = await supabase
  .from('user_briefs')
  .select(`
    *,
    master_briefs (
      pipeline_status,
      pipeline_error,        // ❌ DROPPED
      audio_status,          // ❌ DROPPED
      transcript_content,    // ❌ DROPPED
      ai_condensed_transcript // ❌ DROPPED
    )
  `)

// ✅ CORRECT — use JOINs to new tables
const { data } = await supabase
  .from('user_briefs')
  .select(`
    *,
    master_briefs!inner (
      id,
      pipeline_status,
      summary_text,
      audio_url,
      audio_duration_seconds,
      episode_name,
      podcast_name,
      episode_thumbnail,
      episode_audio_url,
      episode_duration_seconds,
      episode_published_at,
      slug,
      language,
      brief_pipeline_state (
        pipeline_status,
        pipeline_error,
        summary_phase,
        audio_status,
        audio_error
      ),
      brief_transcripts (
        transcript_content,
        ai_condensed_transcript
      )
    )
  `)
```

---

## 2. BREAKING: `user_briefs.total_duration_minutes` Dropped

This column was redundant — the canonical value lives on `master_briefs.total_duration_minutes`.

```typescript
// ❌ BROKEN
const duration = userBrief.total_duration_minutes;

// ✅ CORRECT
const duration = userBrief.master_briefs.total_duration_minutes;
```

---

## 3. New Table: `brief_pipeline_state`

| Column | Type | Default | Description |
|---|---|---|---|
| `id` | uuid | gen_random_uuid() | Primary key |
| `master_brief_id` | uuid | — | FK to master_briefs (UNIQUE, 1:1) |
| `pipeline_status` | text | 'pending' | pending, transcribing, summarizing, recording, completed, failed, summary_failed |
| `pipeline_error` | text | null | Error message if pipeline failed |
| `summary_phase` | text | null | Current summary sub-phase (extraction/synthesis) |
| `audio_status` | text | 'none' | none, pending, processing, completed, failed |
| `audio_error` | text | null | Audio generation error |
| `processing_lock_holder` | text | null | Concurrency lock ID |
| `processing_started_at` | timestamptz | null | Processing start time |
| `transcript_completed_at` | timestamptz | null | Transcript completion time |
| `summary_completed_at` | timestamptz | null | Summary completion time |
| `pipeline_completed_at` | timestamptz | null | Full pipeline completion time |
| `created_at` | timestamptz | now() | Row creation |
| `updated_at` | timestamptz | now() | Auto-updated |

**RLS:** Users can read via `user_briefs` JOIN. Admins can read all. Anonymous denied.

---

## 4. New Table: `brief_transcripts`

| Column | Type | Default | Description |
|---|---|---|---|
| `id` | uuid | gen_random_uuid() | Primary key |
| `master_brief_id` | uuid | — | FK to master_briefs (UNIQUE, 1:1) |
| `transcript_content` | text | null | Full timestamped transcript |
| `ai_condensed_transcript` | text | null | AI-condensed research log |
| `created_at` | timestamptz | now() | Row creation |
| `updated_at` | timestamptz | now() | Auto-updated |

**RLS:** Same as `brief_pipeline_state`.

---

## 5. Edge Function: `generate-taddy-brief` — Retry Logic Change

### Before (old behavior):
- 12 transcript retries with graduated delays (5s, 10s, 15s, ... 30s) totaling ~5 minutes
- Separate `getEpisode` GraphQL query to check `taddyTranscribeStatus` before fetching transcript

### After (new behavior):
- **Maximum 2 Taddy transcript API calls** (1 initial + 1 retry after exactly 60 seconds)
- **No more `getEpisode` status check** — transcript availability determined solely by item count from `getEpisodeTranscript`
- If transcript is still empty or incomplete after 2 calls → brief marked as `failed` with descriptive `pipeline_error`
- User can manually retry via the "Regenerate" button in the UI, which calls `retry-taddy-transcript` or `regenerate-summary`

### Mobile impact:
- **Briefs will fail faster** (~1 minute instead of ~5 minutes) when Taddy transcription isn't ready
- The `pipeline_status` will be `'failed'` and `pipeline_error` (in `brief_pipeline_state`) will contain a descriptive message like:
  - `"Transcript not available after retries — Taddy on-demand transcription may still be processing"`
  - `"Transcript appears incomplete (X chars for Y min episode, expected at least Z)"`
- **Mobile should show a "Try Again" button** when `pipeline_status === 'failed'` so users can manually retry
- The manual retry flow calls `retry-taddy-transcript` with `{ masterBriefId }` — this function fetches the transcript, validates completeness, and if successful updates the brief to `'summarizing'` status and saves the transcript to `brief_transcripts`

---

## 6. Edge Function: `retry-taddy-transcript` — No Changes

This function remains unchanged. It:
1. Accepts `{ masterBriefId }` 
2. Fetches the transcript from Taddy
3. Validates completeness (using `episodeDuration * 3` character threshold)
4. Returns one of:
   - `{ status: "processing" }` (202) — transcript still not available
   - `{ status: "incomplete" }` (200) — transcript exists but appears incomplete
   - `{ status: "completed", transcript }` (200) — success, transcript saved

---

## 7. Edge Function: `regenerate-summary` — No Changes

This function handles manual regeneration when a brief has `summary_failed` status. It:
1. Re-runs the AI synthesis phase using the existing transcript
2. Generates new audio
3. Sends the brief-ready email

---

## 8. Summary Pipeline Error Handling (Reference)

The pipeline has these recoverable failure states:

| Status | Meaning | User Action |
|---|---|---|
| `failed` | Transcript unavailable or pipeline error | Show "Try Again" — calls `generate-taddy-brief` again |
| `summary_failed` | AI summary quality check failed | Show "Regenerate Summary" — calls `regenerate-summary` |

Both states should show a clear message explaining the issue and a retry button.

---

## 9. `acquire_master_brief_lock` Function Updated

The database function `acquire_master_brief_lock` now writes `processing_lock_holder` and `processing_started_at` to `brief_pipeline_state` instead of `master_briefs` (since those columns were dropped from `master_briefs`).

No changes needed on mobile — this is called internally by `generate-taddy-brief`.

---

## 10. Performance Index Added

```sql
CREATE INDEX idx_saved_episodes_user_completed 
ON saved_episodes(user_id, is_completed, created_at DESC);
```

No mobile changes needed — queries are automatically faster.

---

## 11. Dead Code Removed (No Backend Impact)

The following were deleted from the web codebase only. None affect the mobile app:

- Legacy UI components (SummarySection, TranscriptTabs, ProcessingState)
- Unused audio hooks and utilities (Html5AudioPlayer, useAudioPlayer, platform.ts)
- Legacy edge functions that were already non-functional (cleanup-youtube-data, backfill-loops, summarize-brief)
- SHOW_REGENERATE_SUMMARY feature flag (regenerate is now always available)

---

## Quick Reference: Active Edge Functions for Mobile

| Function | Purpose | Auth Required |
|---|---|---|
| `generate-taddy-brief` | Generate AI brief (costs 1 credit) | Yes |
| `retry-taddy-transcript` | Retry transcript fetch for failed brief | Yes |
| `regenerate-summary` | Re-run AI summary for summary_failed brief | Yes |
| `get-signed-audio-url` | Get signed URL for brief audio | Yes |
| `taddy-search` | Search podcasts | No |
| `taddy-podcast-details` | Get podcast + episodes | No |
| `taddy-latest-episodes` | New episodes feed | Yes |
| `get-episode-details` | Single episode details | No |
| `get-show-discovery` | Show page data | No |
| `get-show-episodes` | Paginated episodes for show | No |
| `get-show-briefs` | Paginated briefs for show | No |
| `get-explore-shows` | Featured/popular shows | No |
| `ensure-podcast-metadata` | Register podcast for SEO | No |
| `ensure-episode-metadata` | Register episode for SEO | No |
| `claim-brief` | Claim shared brief | Yes |
| `claim-episode` | Claim shared episode | Yes |
| `create-checkout` | Stripe checkout | Yes |
| `create-credit-refill` | Credit pack purchase | Yes |
| `customer-portal` | Stripe billing portal | Yes |
| `cancel-subscription` | Cancel subscription | Yes |
| `delete-user` | Delete account | Yes |
| `sync-to-loops` | Marketing sync | Yes |
| `log-error` | Error reporting | No |
| `send-internal-notification` | Push notifications | No |

---

*Generated from PodBrief web app changes on February 6, 2026.*
